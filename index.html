<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Control</title>
    
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/jpeg" href="./CryptoControl_icon.png">
    <link rel="apple-touch-icon" href="./CryptoControl_icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca Poderosa para ler Excel (XLSX) e CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
            70% { box-shadow: 0 0 0 4px rgba(52, 211, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
        }

        .live-indicator { display: inline-block; width: 6px; height: 6px; background-color: #34d399; border-radius: 50%; margin-right: 4px; animation: pulse-green 2s infinite; }
        .live-indicator.busy { background-color: #3b82f6; animation: none; box-shadow: 0 0 8px #3b82f6; }
        .live-indicator.error { background-color: #ef4444; animation: none; box-shadow: 0 0 8px #ef4444; }
        .live-indicator.cache { background-color: #f59e0b; animation: none; }

        /* Barra de Progresso no Topo */
        #topProgressBarContainer { position: fixed; top: 0; left: 0; width: 100%; height: 3px; z-index: 9999; pointer-events: none; }
        #topProgressBar { height: 100%; background: #3b82f6; width: 0; transition: width 0.3s ease-out; box-shadow: 0 0 10px #3b82f6; }
        
        .coin-icon-wrapper { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin-img-primary { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .coin-svg-fallback { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: inherit; }
        .coin-svg-fallback svg { width: 65%; height: 65%; }

        .hacker-font { font-family: 'Courier New', monospace; letter-spacing: -0.5px; }
        .log-entry { border-bottom: 1px solid rgba(75, 85, 99, 0.3); padding: 2px 0; font-size: 10px; }
        .log-success { color: #4ade80; } .log-error { color: #f87171; } .log-info { color: #60a5fa; } .log-warn { color: #f59e0b; }
        
        .privacy-blur { filter: blur(5px); user-select: none; opacity: 0.6; transition: filter 0.3s ease; }
        
        /* Bot√£o Range Ativo */
        .range-btn.active { background-color: #374151; color: #fff; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); }

        /* NOVO: Estilos Smart Add */
        .smart-price-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; padding: 0.5rem; }
        
        /* Estilo Unificado do Resumo */
        .summary-box {
            background: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .summary-divider { border-top: 1px dashed #4b5563; margin: 0.5rem 0; }
        
        .date-range-badge { display: inline-block; background: rgba(16, 185, 129, 0.1); color: #34d399; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 4px; border: 1px solid rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col relative select-none">

    <div id="topProgressBarContainer"><div id="topProgressBar"></div></div>

    <div id="helpModal" class="fixed inset-0 bg-black/90 hidden z-[140] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-0 rounded-xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-circle-question text-blue-500 mr-2"></i> Ajuda</h2>
                <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5 space-y-4 text-sm text-gray-300">
                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 flex gap-3">
                    <i class="fa-solid fa-shield-halved text-red-400 text-xl mt-1"></i>
                    <div>
                        <h3 class="text-red-400 font-bold text-xs uppercase">Privacidade Total</h3>
                        <p class="text-[11px] mt-1 leading-tight">Seus dados s√£o salvos <strong>somente neste dispositivo</strong>. N√£o h√° nuvem. Se limpar o cache, os dados somem. Fa√ßa backups!</p>
                    </div>
                </div>
                <h3 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-700 pb-1">Funcionalidades Principais</h3>
                <ul class="space-y-2 list-disc pl-4 text-xs">
                    <li><strong>Olho (<i class="fa-solid fa-eye"></i>):</strong> Oculta saldos.</li>
                    <li><strong>Sincronizar Dados (<i class='fa-solid fa-sync'></i>):</strong> For√ßa uma nova busca de todos os dados (pre√ßos e hist√≥rico) da API.</li>
                    <li><strong>Simulador (<i class="fa-solid fa-wand-magic-sparkles"></i>):</strong> Simula o valor do seu portf√≥lio com base em um pre√ßo futuro do Bitcoin.</li>
                    <li><strong>Console (<i class="fa-solid fa-terminal"></i>):</strong> Exibe logs e o status das opera√ß√µes em segundo plano.</li>
                    <li><strong>Ajustes (<i class="fa-solid fa-gear"></i>):</strong> Permite carregar backups, bases de dados offline, configurar a API e mais.</li>
                </ul>
                <h3 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-700 pb-1 mt-4">Bugs Comuns (API Gratuita)</h3>
                <ul class="space-y-2 list-disc pl-4 text-xs">
                    <li><strong>Lentid√£o:</strong> Com muitas moedas no portf√≥lio, a API gratuita pode ficar lenta.</li>
                    <li><strong>Atraso nas Atualiza√ß√µes:</strong> A API gratuita pode ter atrasos na atualiza√ß√£o dos pre√ßos e dados hist√≥ricos.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="simulatorModal" class="fixed inset-0 bg-black/90 hidden z-[135] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm shadow-2xl relative">
            <button onclick="document.getElementById('simulatorModal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-lg font-bold mb-4 text-white"><i class="fa-solid fa-wand-magic-sparkles text-yellow-400 mr-2"></i> Simulador</h2>
            <div class="mb-4">
                <label class="text-xs text-gray-400 mb-1 block">Se o Bitcoin valer (USD):</label>
                <input type="number" id="simPriceInput" placeholder="Ex: 150000" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white text-lg focus:border-yellow-500 outline-none">
            </div>
            <button onclick="app.runSimulation()" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-2 rounded shadow-lg">Calcular Patrim√¥nio</button>
            <div id="simResult" class="hidden mt-4 text-center bg-black/30 p-3 rounded border border-gray-700">
                <p class="text-gray-500 text-[10px] uppercase">Proje√ß√£o</p>
                <div class="text-2xl font-bold text-green-400" id="simTotalValue">...</div>
                <div class="text-xs text-gray-400" id="simProfit">...</div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/90 hidden z-[130] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-0 rounded-xl w-full max-w-sm shadow-2xl relative overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-gear text-gray-400 mr-2"></i> Ajustes</h2>
                <button onclick="app.closeSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5 space-y-6">
                
                <!-- Se√ß√£o de Importa√ß√£o CSV/Excel -->
                <div>
                    <h3 class="text-[10px] font-bold text-orange-500 uppercase mb-2 border-b border-gray-700 pb-1">Base de Dados Offline (BTC)</h3>
                    <p class="text-[10px] text-gray-400 mb-2">Carregue seu arquivo .xlsx ou .csv (Pre√ßos em D√≥lar).</p>
                    <p class="text-[10px] text-gray-500 mb-2">Exemplo de dados esperados: <a href="https://www.bitget.com/pt/price/bitcoin/historical-data?#download" target="_blank" class="text-blue-400 hover:underline">Bitget Historical Data</a></p>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('csvHistoryInput').click()" class="w-full py-2 bg-orange-600 hover:bg-orange-500 rounded text-xs text-white font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-excel"></i> Carregar Base (.xlsx/.csv)
                        </button>
                        <input type="file" id="csvHistoryInput" accept=".csv, .xlsx, .xls" class="hidden" onchange="app.importHistoryFile(this)">
                    </div>
                    <div id="csvStatus" class="text-[10px] text-gray-500 mt-2 text-center">Nenhum arquivo carregado</div>
                    <div id="csvDateRange" class="hidden text-center mt-1"></div>
                </div>

                <div>
                    <h3 class="text-[10px] font-bold text-green-500 uppercase mb-2 border-b border-gray-700 pb-1">Backup Carteira</h3>
                    <div class="flex gap-2">
                        <button onclick="app.smartSave()" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white font-bold">Salvar</button>
                        <button onclick="document.getElementById('importFile').click()" class="flex-1 py-2 border border-gray-600 hover:bg-gray-700 rounded text-xs text-gray-300">Ler</button>
                        <input type="file" id="importFile" accept=".json" class="hidden" onchange="app.importData(this)">
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-bold text-purple-500 uppercase mb-2 border-b border-gray-700 pb-1">Sincronizar (Texto/JSON)</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="exportCodeInput" readonly class="flex-1 bg-black/30 border border-gray-600 rounded px-2 text-[10px] text-gray-500 truncate" value="...">
                        <button onclick="app.generateExportCode()" class="bg-purple-600 px-3 rounded text-xs font-bold text-white hover:bg-purple-500">Copiar</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="importCodeInput" placeholder="Cole o c√≥digo ou JSON..." class="flex-1 bg-black/30 border border-gray-600 rounded px-2 text-[10px] text-white outline-none focus:border-purple-500">
                        <button onclick="app.importFromCode()" class="bg-gray-700 px-3 rounded text-xs font-bold text-white hover:bg-gray-600">Ok</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-bold text-blue-500 uppercase mb-2 border-b border-gray-700 pb-1">API</h3>
                    <form id="settingsForm" class="space-y-2">
                        <div class="flex gap-2 text-xs">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="apiType" value="free" class="mr-1" checked> <span class="text-gray-300">Free</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="apiType" value="key" class="mr-1"> <span class="text-gray-300">Pro</span></label>
                        </div>
                        <div id="apiKeyField" class="hidden"><input type="text" id="apiKeyInput" placeholder="API Key..." class="w-full bg-black/30 border border-gray-600 rounded p-1 text-xs text-white"></div>
                        <button type="submit" class="w-full py-1 bg-blue-600 rounded text-xs font-bold text-white hover:bg-blue-500">Salvar API</button>
                    </form>
                </div>
                <div>
                    <button onclick="app.forceClearCache()" class="w-full py-1 border border-orange-500/30 text-orange-400 rounded text-xs hover:bg-orange-500/10 mb-2">Limpar Cache</button>
                    <button onclick="localStorage.clear(); location.reload()" class="w-full py-1 border border-red-500/30 text-red-400 rounded text-xs hover:bg-red-500/10">Resetar App</button>
                </div>
            </div>
        </div>
    </div>

    <div id="searchModal" class="fixed inset-0 bg-black/90 hidden z-[120] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md shadow-2xl relative">
            <button onclick="document.getElementById('searchModal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-lg font-bold mb-4 text-white">Adicionar Moeda</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="coinSearchInput" placeholder="Ex: Pepe..." class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                <button onclick="app.searchCoins()" class="bg-blue-600 px-4 rounded text-white font-bold hover:bg-blue-500"><i class="fa-solid fa-search"></i></button>
            </div>
            <div id="searchResults" class="max-h-48 overflow-y-auto space-y-2 text-xs text-center text-gray-500">Digite para buscar.</div>
        </div>
    </div>

    <div id="consoleModal" class="fixed inset-0 bg-black/80 hidden z-[160] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-0 rounded-xl w-full max-w-2xl h-[400px] flex flex-col shadow-2xl overflow-hidden">
            <div class="bg-gray-800 p-3 flex justify-between items-center border-b border-gray-700">
                <span class="text-xs font-mono text-green-400">>_ CONSOLE</span>
                <button onclick="document.getElementById('consoleModal').classList.add('hidden')" class="text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="consoleBody" class="flex-1 bg-black/80 p-3 overflow-y-auto text-[10px] text-gray-300 hacker-font"></div>
            <div class="bg-gray-800 p-2 flex justify-between border-t border-gray-700 text-[10px]">
                <span id="queueStatusText" class="text-gray-500">Idle</span>
                <button onclick="document.getElementById('consoleBody').innerHTML=''" class="text-gray-400 hover:text-white">Limpar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EDI√á√ÉO DE TRANSA√á√ÉO -->
    <div id="editTxModal" class="fixed inset-0 bg-black/90 hidden z-[150] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-0 rounded-xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-pencil text-yellow-400 mr-2"></i> Editar Transa√ß√£o</h2>
                <button onclick="app.closeEditModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5">
                <form id="editTxForm" class="space-y-3">
                    <input type="hidden" id="editTxId">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Moeda</label>
                            <select id="editCoinSelect" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white outline-none focus:border-yellow-500"></select>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">A√ß√£o</label>
                            <select id="editTypeSelect" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white outline-none focus:border-yellow-500">
                                <option value="buy">Comprar</option>
                                <option value="sell">Vender</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Qtd</label>
                            <input type="number" step="any" id="editAmountInput" required class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Pre√ßo Unit√°rio</label>
                            <input type="number" step="any" id="editCostInput" required class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="Pre√ßo de 1 moeda">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Data</label>
                        <input type="date" id="editDateInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white">
                    </div>

                    <div class="border-t border-gray-700 pt-3 mt-3">
                         <label class="text-[10px] font-bold text-purple-400 uppercase">Taxas (%)</label>
                        <div class="grid grid-cols-2 gap-3 mt-2">
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1">Taxa Compra</label>
                                <input type="number" step="0.01" min="0" id="editTaxBuyInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1">Taxa Venda</label>
                                <input type="number" step="0.01" min="0" id="editTaxSellInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded text-xs shadow-lg transform active:scale-95 transition mt-4">SALVAR ALTERA√á√ïES</button>
                </form>
            </div>
        </div>
    </div>

    <nav class="bg-gray-800/90 backdrop-blur-md border-b border-gray-700 p-3 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full overflow-hidden shadow-lg border border-blue-500/30">
                    <img src="./CryptoControl_icon.png" class="w-full h-full object-cover" alt="Logo">
                </div>
                <h1 class="text-lg font-bold tracking-tight text-white">Crypto<span class="text-blue-500">Control</span></h1>
            </div>
            
            <div class="flex items-center space-x-2">
                <div id="apiStatus" class="flex items-center bg-black/40 px-2 py-1 rounded border border-gray-700/50 text-[10px] mr-1 min-w-[70px] justify-center transition-all">
                    <span class="live-indicator"></span> <span class="text-gray-400 font-mono">...</span>
                </div>

                <!-- MOEDA FIAT (BRL/USD) -->
                <div class="flex bg-gray-900 rounded p-0.5 border border-gray-700">
                    <button onclick="app.setCurrency('BRL')" id="btn-currency-brl" class="px-2 py-0.5 text-[10px] font-bold rounded bg-blue-600 text-white transition">BRL</button>
                    <button onclick="app.setCurrency('USD')" id="btn-currency-usd" class="px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-white transition">USD</button>
                </div>

                <!-- UNIDADE BTC (BTC/SATS) -->
                <div class="flex bg-gray-900 rounded p-0.5 border border-gray-700">
                    <button onclick="app.setUnit('BTC')" id="btn-unit-btc" class="px-2 py-0.5 text-[10px] font-bold rounded bg-orange-500 text-white transition">BTC</button>
                    <button onclick="app.setUnit('SATS')" id="btn-unit-sats" class="px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-white transition">SATS</button>
                </div>
                
                <button onclick="document.getElementById('simulatorModal').classList.remove('hidden')" class="p-1.5 text-yellow-400 hover:bg-gray-700 rounded transition"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                <button onclick="document.getElementById('helpModal').classList.remove('hidden')" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition"><i class="fa-solid fa-circle-question"></i></button>
                <button onclick="app.openSettings()" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition"><i class="fa-solid fa-gear"></i></button>
                <button onclick="app.refreshAll(true)" class="p-1.5 text-blue-400 hover:text-white hover:bg-gray-700 rounded transition" title="For√ßar Atualiza√ß√£o"><i class="fa-solid fa-sync"></i></button>
                <button onclick="app.toggleConsole()" class="p-1.5 text-gray-500 hover:text-green-400 hover:bg-gray-700 rounded transition"><i class="fa-solid fa-terminal"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel rounded-xl p-6 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-wallet text-6xl text-white"></i></div>
                
                <div class="flex items-center mb-1">
                    <h2 class="text-xs font-bold text-gray-400 uppercase mr-2">Patrim√¥nio Total</h2>
                    <button onclick="app.togglePrivacy()" class="text-gray-500 hover:text-white transition text-xs" title="Ocultar/Mostrar Valores">
                        <i class="fa-solid fa-eye" id="privacyIconMobile"></i>
                    </button>
                </div>
                
                <div class="text-3xl font-bold text-white tracking-tight mb-2" id="totalBalance">...</div>
                <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-700/50">
                    <div><div class="text-[10px] text-gray-500 uppercase">Investido</div><div class="text-sm text-gray-300 font-mono" id="totalInvested">...</div></div>
                    <div class="text-right"><div class="text-[10px] text-gray-500 uppercase">Lucro/Preju√≠zo</div><div class="text-sm font-bold font-mono" id="totalPnL">...</div></div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">Mayer Multiple (BTC)</h3>
                    <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-500">Bitbo Style</span>
                </div>
                <div class="flex items-end gap-2">
                    <div class="text-2xl font-bold text-white" id="mayerValue">---</div>
                    <div class="text-xs text-gray-400 mb-1" id="mayerStatus">Carregando...</div>
                </div>
                <div class="w-full bg-gray-800 h-2 mt-2 rounded-full overflow-hidden relative">
                    <div class="absolute top-0 left-0 h-full w-1/3 bg-green-500/30"></div>
                    <div class="absolute top-0 left-1/3 h-full w-1/3 bg-yellow-500/30"></div>
                    <div class="absolute top-0 right-0 h-full w-1/3 bg-red-500/30"></div>
                    <div id="mayerIndicator" class="h-full w-1 bg-white absolute top-0 shadow-[0_0_10px_white] transition-all duration-500" style="left: 0%"></div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 shadow-lg flex flex-col items-center justify-center h-56 relative">
                <h3 class="text-xs font-bold text-gray-400 w-full text-left mb-2">Aloca√ß√£o</h3>
                <canvas id="portfolioChart"></canvas>
                <div id="emptyChartMsg" class="hidden text-gray-500 text-xs absolute">Carteira Vazia</div>
            </div>

            <div id="formContainer" class="bg-gray-800 rounded-xl p-5 border border-gray-700 shadow-lg transition-all duration-300 border-l-4 border-l-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-white flex items-center">
                        <div id="formIconContainer" class="w-6 h-6 mr-2 flex items-center justify-center bg-gray-700 rounded-full overflow-hidden"></div>
                        Nova Transa√ß√£o
                    </h3>
                    <button onclick="document.getElementById('searchModal').classList.remove('hidden')" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded uppercase font-bold tracking-wide"><i class="fa-solid fa-plus mr-1"></i> Moeda</button>
                </div>
                <form id="txForm" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Moeda</label>
                            <select id="coinSelect" onchange="app.updateFormTheme()" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white outline-none focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">A√ß√£o</label>
                            <select id="typeSelect" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white outline-none focus:border-blue-500"><option value="buy">Comprar</option><option value="sell">Vender</option></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Qtd <span id="qtyUnitLabel" class="text-orange-500 font-bold text-[9px]">(BTC)</span></label>
                            <input type="number" step="0.00000001" id="amountInput" required class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00" oninput="app.calculateBreakEven()">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Pre√ßo Unit√°rio (<span id="costCurrencyLabel">R$</span>)</label>
                            <input type="number" step="0.01" id="costInput" required class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="Pre√ßo de 1 moeda" oninput="app.calculateBreakEven()">
                        </div>
                    </div>
                    
                    <!-- NOVO: PAINEL DE RESUMO UNIFICADO -->
                    <div id="calculationSummary" class="hidden bg-gray-800/50 border border-gray-700 rounded-lg p-3 mt-3 mb-3">
                        <!-- Linha 1: Total Gasto -->
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-gray-400 uppercase tracking-wider">Total Gasto</span>
                            <span class="text-sm font-bold text-white font-mono" id="calcTotalValue">...</span>
                        </div>
                        <!-- Linha 2: Break-even (Sempre vis√≠vel dentro do box) -->
                        <div class="flex justify-between items-center pt-2 border-t border-gray-700/50">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-purple-400 font-bold uppercase tracking-wider">Break-even</span>
                                <span class="text-[9px] text-gray-500" id="calcBreakEvenMsg">Venda acima de...</span>
                            </div>
                            <span class="text-sm font-bold text-purple-300 font-mono" id="calcBreakEvenValue">...</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Data <span class="text-blue-300 text-[9px]">(data antiga = busca pre√ßo unit√°rio)</span></label>
                        <div class="flex gap-2">
                            <input type="date" id="dateInput" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" onchange="app.smartFetchPrice()">
                            <button type="button" onclick="app.smartFetchPrice()" class="bg-blue-600 hover:bg-blue-500 px-2 rounded text-white text-xs font-bold"><i class="fa-solid fa-sync"></i></button>
                        </div>
                        <div id="smartPriceInfo" class="smart-price-box text-xs text-blue-300 mt-2 hidden">
                            <i class="fa-solid fa-info-circle mr-1"></i> <span id="smartPriceText">Carregando pre√ßo...</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-700 pt-3 mt-3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] font-bold text-purple-400 uppercase">Taxas (%)</label>
                            <button type="button" onclick="document.getElementById('taxesHelp').classList.toggle('hidden')" class="text-gray-500 hover:text-purple-400 text-xs">
                                <i class="fa-solid fa-circle-question"></i>
                            </button>
                        </div>
                        
                        <div id="taxesHelp" class="hidden bg-purple-500/10 border border-purple-500/30 rounded p-2 mb-2 text-[10px] text-gray-300">
                            <p><strong>Taxa de Compra:</strong> Taxa sobre valor total (exchange, saque, etc)</p>
                            <p><strong>Taxa de Venda:</strong> Taxa na sa√≠da para c√°lculo do break-even</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1">Taxa Compra</label>
                                <input type="number" step="0.01" min="0" id="taxBuyInput" value="0" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00" onchange="app.calculateBreakEven()">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1">Taxa Venda</label>
                                <input type="number" step="0.01" min="0" id="taxSellInput" value="0" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white" placeholder="0.00" onchange="app.calculateBreakEven()">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-xs shadow-lg transform active:scale-95 transition">ADICIONAR</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="glass-panel rounded-xl p-4 shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400">Hist√≥rico</h3>
                    <div class="flex bg-gray-800 rounded p-0.5">
                        <button onclick="app.changeRange(30)" id="range30" class="range-btn active px-2 py-0.5 text-[10px] rounded text-gray-400 hover:text-white hover:bg-gray-700 transition">30D</button>
                        <button onclick="app.changeRange(90)" id="range90" class="range-btn px-2 py-0.5 text-[10px] rounded text-gray-400 hover:text-white hover:bg-gray-700 transition">90D</button>
                        <button onclick="app.changeRange(180)" id="range180" class="range-btn px-2 py-0.5 text-[10px] rounded text-gray-400 hover:text-white hover:bg-gray-700 transition">6M</button>
                        <button onclick="app.changeRange(365)" id="range365" class="range-btn px-2 py-0.5 text-[10px] rounded text-gray-400 hover:text-white hover:bg-gray-700 transition">1A</button>
                    </div>
                </div>
                <div class="w-full h-56 relative"><canvas id="historyChart"></canvas></div>
            </div>

            <div id="assetsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

            <div class="glass-panel rounded-xl border border-gray-700 overflow-hidden">
                <div class="bg-gray-800/50 p-3 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-400">√öltimas Transa√ß√µes</h3>
                    <div class="flex items-center gap-4">
                        <button onclick="app.exportToCsv()" class="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-1">
                            <i class="fa-solid fa-file-export"></i> Exportar
                        </button>
                        <button onclick="app.clearAllData()" class="text-[10px] text-red-400 hover:text-red-300">Limpar Tudo</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-60">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-900 text-gray-500 font-normal">
                            <tr><th class="p-3 font-normal">Data</th><th class="p-3 font-normal">Ativo</th><th class="p-3 font-normal">Tipo</th><th class="p-3 text-right font-normal">Qtd</th><th class="p-3 text-right font-normal">Valor</th><th class="p-3 text-right font-normal">B.E.</th><th class="p-3"></th></tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="border-t border-gray-800 mt-6 py-8 text-center bg-gray-900/90 backdrop-blur-md">
        <p class="text-gray-500 text-sm font-mono mb-4">By Arthur Miguel</p>
        <div class="inline-block bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 max-w-sm mx-auto">
        <p class="text-xs text-gray-400 mb-2 px-2"><i class="fa-solid fa-heart text-red-500 mr-2"></i>Se este projeto te ajudou, considere apoiar com um caf√© ‚òï</p>
            <div class="mb-2 bg-white p-2 rounded-lg inline-block">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=lightning:arthurmiguel@bipa.app" alt="QR" class="w-32 h-32">
            </div>
            <div class="flex items-center gap-2 bg-black/30 rounded p-2 cursor-pointer hover:bg-black/50 transition mb-2" onclick="app.copyLightningAddress()">
                <div class="bg-yellow-500 text-black w-5 h-5 rounded-full flex items-center justify-center"><i class="fa-solid fa-bolt text-[10px]"></i></div>
                <span class="text-[10px] font-mono text-gray-300">arthurmiguel@bipa.app</span>
                <i class="fa-regular fa-copy text-yellow-400 text-lg group-hover:scale-110 transition ml-2"></i>
            </div>
            <div class="flex items-center gap-2 bg-black/30 rounded p-2 cursor-pointer hover:bg-black/50 transition" onclick="app.copyDonationAddress()">
                <i class="fa-brands fa-bitcoin text-gray-500"></i>
                <span class="text-[10px] font-mono text-gray-300 truncate w-48">Bc1qn9gjwevesf8xhqamvt8lcnwmyz4e5lfdqzc7h0</span>
                <i class="fa-regular fa-copy text-gray-500 text-xs"></i>
            </div>
        </div>
    </footer>

    <script>
        const ICONS = {
            BTC: '<path d="M17.05,10.28C16.5,8.11 14.75,6.4 12.31,5.88V3.38H9.81V5.88H8.31V3.38H5.81V5.92H2.31V8.42H3.81C4.64,8.42 5.31,9.09 5.31,9.92V17.56C5.31,18.39 4.64,19.06 3.81,19.06H2.31V21.56H5.81V21.56H5.81V24.06H8.31V21.53H9.81V24.03H12.31V21.14C15.39,20.73 17.62,18.68 17.19,15.86C16.96,14.37 16.09,13.26 14.93,12.69C15.96,12.15 16.78,11.03 17.05,10.28M13.03,17.53H10.34V14.03H13.03C14,14.03 14.78,14.81 14.78,15.78C14.78,16.75 14,17.53 13.03,17.53M12.55,12.03H10.34V9.03H12.55C13.38,9.03 14.05,9.7 14.05,10.53C14.05,11.36 13.38,12.03 12.55,12.03Z"/>',
            ETH: '<path d="M11.944 17.97L4.58 13.62 11.943 24l7.37-10.38-7.372 4.35h.003zM12.056 0L4.69 12.223l7.365 4.354 7.365-4.35L12.056 0z"/>',
            SOL: '<path d="M19.437 8.71c.03 0 .059-.006.086-.017l.051-.023a.603.603 0 0 0 .233-.184l.032-.046c.179-.316.105-.725-.208-.934L5.266 1.13a.81.81 0 0 0-.353-.13H3.954c-.03 0-.059.006-.087.017l-.05.023a.608.608 0 0 0-.234.184l-.032.046c-.178.316-.105.725.209.934l14.365 6.377a.815.815 0 0 0 .353.13h.96zm.61 6.58c.03 0 .058-.006.086-.017l.05-.023a.604.604 0 0 0 .234-.184l.032-.046c.179-.316.105-.725-.208-.934L5.875 7.71a.81.81 0 0 0-.352-.13H4.563c-.03 0-.059.006-.087.017l-.05.023a.61.61 0 0 0-.23.184l-.03.046c-.18.316-.1.725.21.934l14.36 6.376a.81.81 0 0 0 .35.13h.96z"/>',
            ADA: '<path d="M12 13.55c.85 0 1.54-.7 1.54-1.55a1.545 1.545 0 1 0-1.54 1.55zm4.25-1.55c0 .86.69 1.55 1.55 1.55.85 0 1.55-.69 1.55-1.55 0-.85-.7-1.55-1.55-1.55-.86 0-1.55.7-1.55 1.55zM7.75 12c0 .86.69 1.55 1.55 1.55.85 0 1.55-.69 1.55-1.55 0-.85-.7-1.55-1.55-1.55-.86 0-1.55.7-1.55 1.55zm4.25 4.25c.85 0 1.54-.7 1.54-1.55a1.545 1.545 0 1 0-1.54 1.55zm0-8.5c.85 0 1.54-.7 1.54-1.55A1.545 1.545 0 1 0 12 7.75zm-4.25 4.25c.85 0 1.54-.7 1.54-1.55a1.545 1.545 0 1 0-1.54 1.55zm8.5 0c.85 0 1.54-.7 1.54-1.55a1.545 1.545 0 1 0-1.54 1.55zM12 2.25A1.545 1.545 0 1 0 12 5.35c.85 0 1.54-.7 1.54-1.55 0-.86-.69-1.55-1.54-1.55zm0 19.5a1.545 1.545 0 1 0 0 3.1 1.545 1.545 0 0 0 0-3.1zm9.75-9.75a1.545 1.545 0 1 0 0 3.1 1.545 1.545 0 0 0 0-3.1zM2.25 12a1.545 1.545 0 1 0 0 3.1 1.545 1.545 0 0 0 0-3.1z"/>',
            XRP: '<path d="M12.005 13.572l6.338 6.387 1.413-1.416-6.402-6.328 6.326-6.22-1.412-1.416-6.263 6.29-6.34-6.368-1.414 1.416 6.42 6.298-6.327 6.232 1.414 1.416z"/>'
        };

        const DEFAULT_COINS = {
            'bitcoin': { symbol: 'BTC', name: 'Bitcoin', color: '#f59e0b', image: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png', path: ICONS.BTC },
            'ethereum': { symbol: 'ETH', name: 'Ethereum', color: '#6366f1', image: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png', path: ICONS.ETH },
            'solana': { symbol: 'SOL', name: 'Solana', color: '#14b8a6', image: 'https://assets.coingecko.com/coins/images/4128/small/solana.png', path: ICONS.SOL },
            'cardano': { symbol: 'ADA', name: 'Cardano', color: '#3b82f6', image: 'https://assets.coingecko.com/coins/images/975/small/cardano.png', path: ICONS.ADA },
            'ripple': { symbol: 'XRP', name: 'Ripple', color: '#ffffff', image: 'https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png', path: ICONS.XRP }
        };

        const safeParse = (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } };

        class CryptoApp {
            constructor() {
                window.onerror = (msg) => console.error("App Error: " + msg);

                const savedCustom = safeParse('crypto_custom_coins', {});
                this.coinMap = { ...savedCustom, ...DEFAULT_COINS }; 
                this.transactions = safeParse('crypto_txs', []);
                this.apiConfig = safeParse('crypto_api_config', { type: 'free', key: '' });
                this.displayCurrency = localStorage.getItem('crypto_currency') || 'BRL';
                // NOVO: Unidade de Exibi√ß√£o (BTC ou SATS)
                this.displayUnit = localStorage.getItem('crypto_unit') || 'BTC';
                this.privacyMode = localStorage.getItem('crypto_privacy') === 'true' || false;

                this.cacheDuration = 300000; // 5 Minutos
                this.prices = {};
                this.rateBrlToUsd = 0;
                this.nextUpdate = 0; 
                this.isAutoRefreshing = false; 

                this.requestQueue = [];
                this.isProcessingQueue = false;
                this.chartDays = safeParse('crypto_chart_days', 30); 
                
                this.queueDelay = 15000; 
                this.cooldownTime = 0; 
                
                this.historyCache = safeParse('crypto_history_cache', {}); 
                
                // CARREGA OS DADOS DO LOCALSTORAGE
                this.localData = safeParse('crypto_local_history', {});

                // Bindings
                this.log = this.log.bind(this);
                this.refreshAll = this.refreshAll.bind(this);
                this.toggleConsole = this.toggleConsole.bind(this);
                this.openSettings = this.openSettings.bind(this);
                this.closeSettings = this.closeSettings.bind(this);
                this.updateFormTheme = this.updateFormTheme.bind(this);
                this.saveSettings = this.saveSettings.bind(this);
                this.handleAddTransaction = this.handleAddTransaction.bind(this);
                this.setApiStatusUI = this.setApiStatusUI.bind(this);
                this.addToQueue = this.addToQueue.bind(this);
                this.processQueue = this.processQueue.bind(this);
                this.getIconHtml = this.getIconHtml.bind(this);
                this.formatMoney = this.formatMoney.bind(this);
                this.formatQuantity = this.formatQuantity.bind(this);
                this.updateCurrencyUI = this.updateCurrencyUI.bind(this);
                this.forceClearCache = this.forceClearCache.bind(this);
                this.renderHistory = this.renderHistory.bind(this);
                this.updateDonut = this.updateDonut.bind(this);
                this.updateLineChart = this.updateLineChart.bind(this);
                this.importData = this.importData.bind(this);
                this.updateTitle = this.updateTitle.bind(this);
                this.updateRangeUI = this.updateRangeUI.bind(this);
                this.fetchHistory = this.fetchHistory.bind(this);
                this.togglePrivacy = this.togglePrivacy.bind(this);
                this.smartFetchPrice = this.smartFetchPrice.bind(this);
                this.calculateBreakEven = this.calculateBreakEven.bind(this);
                this.importHistoryFile = this.importHistoryFile.bind(this);
                this.showDateRange = this.showDateRange.bind(this); 
                this.setUnit = this.setUnit.bind(this); // NOVO
                this.updateUnitUI = this.updateUnitUI.bind(this); // NOVO

                // Fun√ß√µes de Edi√ß√£o e Exporta√ß√£o
                this.openEditModal = this.openEditModal.bind(this);
                this.closeEditModal = this.closeEditModal.bind(this);
                this.handleUpdateTransaction = this.handleUpdateTransaction.bind(this);
                this.exportToCsv = this.exportToCsv.bind(this);

                this.initUI();
                this.loadPricesFromCache();
                this.refreshAll();
                
                // Tenta carregar arquivo local (opcional, caso rode servidor)
                this.tryLoadLocalFile();

                setInterval(() => this.updateCooldownVisual(), 1000);
            }

            // Tenta carregar apenas se tiver no servidor, silencioso se falhar
            async tryLoadLocalFile() {
                if(Object.keys(this.localData).length > 0) {
                    this.showDateRange(); // Mostra as datas se j√° tiver dados
                    return;
                }
                try {
                    const res = await fetch('./bitcoin.xlsx');
                    if (!res.ok) {
                        // If .xlsx fails, try .csv as a fallback
                        const resCsv = await fetch('./bitcoin.csv');
                        if (!resCsv.ok) return; // if both fail, just return
                        const text = await resCsv.text();
                        this.processCsvData(text); // This one has its own logging, no alerts
                        this.log('Base de dados local (bitcoin.csv) carregada.', 'success');
                        return;
                    };
                    const data = await res.arrayBuffer();
                    const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    this.processData(jsonData, true); // Pass true for silent
                    this.log('Base de dados local (bitcoin.xlsx) carregada.', 'success');
                } catch (e) {
                    this.log('Nenhum arquivo de base de dados local encontrado (' + e.message + ')', 'warn');
                }
            }

            // NOVO: Mostra intervalo de datas (primeira e √∫ltima)
            showDateRange() {
                const dates = Object.keys(this.localData).sort();
                const elRange = document.getElementById('csvDateRange');
                const elStatus = document.getElementById('csvStatus');
                
                if (dates.length > 0 && elRange) {
                    const first = dates[0].split('-').reverse().join('/');
                    const last = dates[dates.length - 1].split('-').reverse().join('/');
                    
                    elRange.innerHTML = `<div class="date-range-badge">üìÖ ${first} at√© ${last}</div>`;
                    elRange.classList.remove('hidden');
                    
                    if(elStatus) {
                        elStatus.innerText = `${dates.length} datas carregadas na mem√≥ria.`;
                        elStatus.classList.add('text-green-500');
                    }
                    this.log(`Intervalo BTC: ${first} - ${last}`, 'info');
                }
            }

            // NOVO: Processa o Arquivo (XLSX ou CSV) enviado pelo usu√°rio
            importHistoryFile(input) {
                const f = input.files[0];
                if(!f) return;
                
                const r = new FileReader();
                
                // Usamos ArrayBuffer para suportar XLSX e CSV via SheetJS
                r.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Converte para JSON (Array de Arrays) - Mais robusto que texto
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        this.processData(jsonData);
                        alert('Base de dados carregada com sucesso!');
                    } catch(err) {
                        console.error(err);
                        alert('Erro ao ler arquivo. Verifique se √© um .xlsx ou .csv v√°lido.');
                    }
                };
                r.readAsArrayBuffer(f);
                
                input.value = '';
            }

            processData(rows, silent = false) {
                let count = 0;
                
                // Ignora cabe√ßalho (linha 0)
                const dataRows = rows.slice(1);
                
                dataRows.forEach(cols => {
                    if (!cols || cols.length < 2) return;
                    
                    // Tenta pegar timestamp da coluna 0
                    // Tenta pegar pre√ßo da coluna 7 (ou ultima se n√£o tiver 8)
                    try {
                        // Verifica se √© um n√∫mero ou string num√©rica
                        const ts = typeof cols[0] === 'number' ? cols[0] : parseInt(cols[0]);
                        
                        // Procura pre√ßo na coluna 7 (√≠ndice 7 = 8¬™ coluna), ou na √∫ltima dispon√≠vel
                        let priceVal = cols[7];
                        if (priceVal === undefined) priceVal = cols[cols.length-1];
                        
                        // Trata v√≠rgula decimal se for string (ex: "92094,53")
                        if (typeof priceVal === 'string') {
                            priceVal = priceVal.replace(',', '.');
                        }
                        const price = parseFloat(priceVal);

                        if (!isNaN(ts) && !isNaN(price)) {
                            // IMPORTANTE: Usa UTC para garantir consist√™ncia com o input date HTML
                            const date = new Date(ts);
                            // Garante YYYY-MM-DD
                            const dateStr = date.toISOString().split('T')[0]; 
                            this.localData[dateStr] = price;
                            count++;
                        }
                    } catch(e) {}
                });

                if(count > 0) {
                    localStorage.setItem('crypto_local_history', JSON.stringify(this.localData));
                    this.showDateRange(); // Atualiza a UI com as datas
                    this.log(`Importado: ${count} datas de BTC.`, 'success');
                    if (!silent) alert('Base de dados carregada com sucesso!');
                } else {
                    if (!silent) alert('Nenhum dado v√°lido encontrado. Verifique as colunas (Timestamp na 1¬™, PriceClose na 8¬™).');
                }
            }
            
            // Tenta processar CSV puro se falhar o xlsx (fallback para o bot√£o de CSV espec√≠fico)
            processCsvData(text) {
                const lines = text.split('\n').slice(1); // Remove header
                let count = 0;
                
                lines.forEach(line => {
                    const cols = line.trim().split(/[\t,;]+/); // Split by tab, comma, or semicolon
                    
                    if (cols.length < 2) return;
                    try {
                        const ts = parseInt(cols[0]);
                        // Tenta pegar a pen√∫ltima coluna ou a 8a (√≠ndice 7)
                        let priceVal = cols[7] || cols[cols.length - 2]; 
                        
                        if (typeof priceVal === 'string') priceVal = priceVal.replace(',', '.');
                        const price = parseFloat(priceVal);

                        if (!isNaN(ts) && !isNaN(price)) {
                            const date = new Date(ts);
                            const dateStr = date.toISOString().split('T')[0]; 
                            this.localData[dateStr] = price;
                            count++;
                        }
                    } catch(e) {}
                });

                if(count > 0) {
                    localStorage.setItem('crypto_local_history', JSON.stringify(this.localData));
                    this.showDateRange();
                    this.log(`Importado CSV: ${count} datas.`, 'success');
                }
            }

            // --- UI HELPERS ---
            getIconHtml(config) {
                if (config && config.path) {
                    const bg = config.symbol === 'XRP' ? '#333' : config.color;
                    return `<div class="coin-icon-wrapper" style="background-color: ${bg}"><img src="${config.image}" class="coin-img-primary" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="coin-svg-fallback" style="display: none;"><svg viewBox="0 0 24 24" fill="#ffffff">${config.path}</svg></div></div>`;
                }
                return `<img src="${config.image}" class="w-full h-full rounded-full">`;
            }

            formatMoney(value, symbol) {
                if (this.privacyMode) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                return `${symbol} ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            formatQuantity(value, symbol) {
                if (this.privacyMode) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                
                // NOVA L√ìGICA: Se for Bitcoin e o modo for SATS, converte
                if (symbol === 'BTC' && this.displayUnit === 'SATS') {
                    const sats = value * 100000000;
                    return `${sats.toLocaleString('pt-BR', { maximumFractionDigits: 0 })} Sats`;
                }
                
                return `${value.toFixed(6)} ${symbol}`;
            }

            toggleConsole() { const el = document.getElementById('consoleModal'); if(el) el.classList.toggle('hidden'); }
            openSettings() { const el = document.getElementById('settingsModal'); if(el) el.classList.remove('hidden'); }
            closeSettings() { const el = document.getElementById('settingsModal'); if(el) el.classList.add('hidden'); }
            
            log(msg, type='info') { 
                const b = document.getElementById('consoleBody'); 
                if(!b) return;
                const d = document.createElement('div'); 
                d.className = `log-entry log-${type}`; 
                d.innerText = `> ${msg}`; 
                b.appendChild(d); 
                b.scrollTop = b.scrollHeight; 
            }

            updateCooldownVisual() {
                const diff = Math.max(0, Math.ceil((this.cooldownTime - Date.now()) / 1000));
                const elStatus = document.getElementById('apiStatus');
                if(!elStatus) return;
                const txt = elStatus.querySelector('span:last-child');
                
                if(this.isProcessingQueue && diff > 0 && txt) {
                    txt.innerText = `‚è≥ ${diff}s`;
                    txt.className = 'text-blue-300 font-mono animate-pulse';
                }
            }

            setApiStatusUI(text, type) {
                const el = document.getElementById('apiStatus');
                if(!el) return;
                const dot = el.querySelector('.live-indicator');
                const txt = el.querySelector('span:last-child');
                
                if(dot) dot.className = `live-indicator mr-1 ${type === 'live' ? '' : type}`;
                if(txt) {
                    txt.innerText = text;
                    txt.className = 'font-mono ' + (type === 'live' ? 'text-green-400' : type === 'cache' ? 'text-yellow-500' : type === 'busy' ? 'text-blue-400 animate-pulse' : 'text-red-400');
                }
            }

            updateProgressBar(pct) {
                const bar = document.getElementById('topProgressBar');
                if(bar) {
                    bar.style.width = `${pct}%`;
                    if(pct >= 100 || pct === 0) setTimeout(() => { if(bar) bar.style.width = '0%'; }, 500);
                }
            }

            getApiUrl(ep) {
                let u = `https://api.coingecko.com/api/v3${ep}`;
                if(this.apiConfig.type === 'key' && this.apiConfig.key) u += `${u.includes('?')?'&':'?'}x_cg_demo_api_key=${this.apiConfig.key}`;
                return u;
            }

            updateTitle() {
                if(this.privacyMode) { document.title = "Crypto Control V2"; return; }
                if(this.prices && this.prices.bitcoin) {
                    const btc = this.displayCurrency === 'BRL' ? this.prices.bitcoin.brl : this.prices.bitcoin.usd;
                    const sym = this.displayCurrency === 'BRL' ? 'R$' : '$';
                    document.title = `BTC ${sym} ${(btc/1000).toFixed(1)}k`;
                }
            }

            updateRangeUI() {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById(`range${this.chartDays}`);
                if(btn) btn.classList.add('active');
            }

            // --- INIT ---
            initUI() {
                const dateInput = document.getElementById('dateInput');
                if(dateInput) dateInput.valueAsDate = new Date();
                
                this.populateCoinSelect(document.getElementById('coinSelect'));
                this.populateCoinSelect(document.getElementById('editCoinSelect'));
                this.updateCurrencyUI();
                this.updateUnitUI(); // NOVO: Atualiza UI da Unidade
                this.updateFormTheme();
                this.setApiStatusUI('Pronto', 'live');
                this.updateRangeUI();
                
                // Atualiza √≠cone de privacidade
                const privIcon = document.getElementById('privacyIconMobile');
                if(privIcon) privIcon.className = this.privacyMode ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
                
                // Listeners
                const setForm = document.getElementById('settingsForm');
                if(setForm) setForm.onsubmit = this.saveSettings;
                
                const txForm = document.getElementById('txForm');
                if(txForm) txForm.onsubmit = this.handleAddTransaction;
                
                const editTxForm = document.getElementById('editTxForm');
                if(editTxForm) editTxForm.onsubmit = this.handleUpdateTransaction;
                
                document.querySelectorAll('input[name="apiType"]').forEach(r => {
                    r.onchange = (e) => {
                        const f = document.getElementById('apiKeyField');
                        if(f) f.classList.toggle('hidden', e.target.value === 'free');
                    }
                });
            }

            populateCoinSelect(sel) {
                if(!sel) return;
                const currentValue = sel.value;
                sel.innerHTML = '';
                
                // Sort Bitcoin first
                const sortedIds = Object.keys(this.coinMap).sort((a, b) => {
                    if (a === 'bitcoin') return -1;
                    if (b === 'bitcoin') return 1;
                    return this.coinMap[a].name.localeCompare(this.coinMap[b].name);
                });

                sortedIds.forEach(id => {
                    const c = this.coinMap[id];
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = `${c.name} (${c.symbol})`;
                    sel.appendChild(opt);
                });

                if (currentValue && this.coinMap[currentValue]) {
                    sel.value = currentValue;
                } else if (this.coinMap['bitcoin']) {
                    sel.value = 'bitcoin';
                }
            }

            updateFormTheme() {
                const sel = document.getElementById('coinSelect');
                if(!sel) return;
                const c = this.coinMap[sel.value];
                if(!c) return;
                
                const iconDiv = document.getElementById('formIconContainer');
                if(iconDiv) iconDiv.innerHTML = this.getIconHtml(c);
                
                const btn = document.getElementById('submitBtn');
                if(btn) btn.style.backgroundColor = c.color || '#d97706';
                
                const form = document.getElementById('formContainer');
                if(form) form.style.borderColor = c.color || '#d97706';
            }

            // --- QUEUE SYSTEM ---
            addToQueue(taskFn) {
                this.requestQueue.push(taskFn);
                if (!this.isProcessingQueue) this.processQueue();
            }

            async processQueue() {
                if (this.requestQueue.length === 0) {
                    this.isProcessingQueue = false;
                    this.updateProgressBar(0);
                    this.setApiStatusUI('API OK', 'live');
                    return;
                }
                this.isProcessingQueue = true;
                const task = this.requestQueue.shift();
                this.cooldownTime = Date.now() + this.queueDelay;
                
                this.setApiStatusUI('Carregando...', 'busy');
                try { await task(); } catch(e) { this.log('Queue Error', 'error'); }

                await new Promise(r => setTimeout(r, this.queueDelay));
                this.processQueue();
            }

            // --- DATA ---
            loadPricesFromCache() {
                const cached = safeParse('crypto_prices_cache', null);
                if (cached && cached.data) {
                    this.prices = cached.data;
                    this.rateBrlToUsd = cached.rate || 0;
                    this.nextUpdate = cached.ts + this.cacheDuration;
                    if(Date.now() > this.nextUpdate) this.nextUpdate = Date.now();
                    
                    this.calculatePortfolio();
                    this.setApiStatusUI('Cache', 'cache');
                    this.log('Cache carregado.', 'info');
                    
                    // Tenta carregar gr√°fico imediatamente do cache
                    this.fetchHistory(); 
                }
            }

            async refreshAll(force = false) {
                if(this.isAutoRefreshing) return;
                
                const now = Date.now();
                const ids = Object.keys(this.coinMap).join(',');
                
                if (!force && this.nextUpdate > now && Object.keys(this.prices).length > 0) {
                    this.log('Cache v√°lido.', 'info');
                    this.fetchHistory(); // Garante que grafico carregue mesmo se preco estiver em cache
                    return;
                }

                this.isAutoRefreshing = true;
                this.setApiStatusUI('Buscando...', 'busy');
                this.log('Atualizando pre√ßos...', 'info');
                this.nextUpdate = Date.now() + 60000;

                try {
                    const url = this.getApiUrl(`/simple/price?ids=${ids}&vs_currencies=brl,usd&include_24hr_change=true`);
                    const res = await fetch(url);
                    if(!res.ok) throw new Error(res.status);
                    
                    this.prices = await res.json();
                    if(this.prices.bitcoin) {
                        this.rateBrlToUsd = this.prices.bitcoin.usd / this.prices.bitcoin.brl;
                    }

                    localStorage.setItem('crypto_prices_cache', JSON.stringify({
                        ts: Date.now(), data: this.prices, rate: this.rateBrlToUsd
                    }));
                    
                    this.nextUpdate = Date.now() + this.cacheDuration;
                    this.calculatePortfolio();
                    this.setApiStatusUI('API OK', 'live');
                    this.log('Pre√ßos OK.', 'success');

                    this.fetchHistory(force); 
                } catch(e) {
                    this.setApiStatusUI('Erro API', 'error');
                    this.log('Erro API: ' + e.message, 'error');
                } finally {
                    this.isAutoRefreshing = false;
                }
            }

            fetchHistory(force = false) {
                const active = [...new Set(this.transactions.map(t => t.coinId))];
                if(active.length === 0) {
                    if(this.coinMap.bitcoin) active.push('bitcoin');
                    else return;
                }
                if(!active.includes('bitcoin') && this.coinMap.bitcoin) active.unshift('bitcoin');
                else if(active.includes('bitcoin')) {
                     const idx = active.indexOf('bitcoin');
                     if(idx > 0) { active.splice(idx, 1); active.unshift('bitcoin'); }
                }

                const targets = [...new Set(active)].slice(0, 5); 
                const vs = 'usd';
                const now = Date.now();
                const fetchDays = 365; // Sempre baixa 1 ano

                this.requestQueue = []; 

                targets.forEach((id, idx) => {
                    const key = `${id}_usd_${fetchDays}`;
                    
                    if(!force && this.historyCache[key] && (now - this.historyCache[key].ts < 43200000)) {
                        if(id === 'bitcoin') this.calculateMayer(this.historyCache[key].data);
                        this.updateLineChart(targets); // Desenha se tiver cache
                        return;
                    }

                    this.addToQueue(async () => {
                        this.updateProgressBar(Math.round(((idx + 1) / targets.length) * 100));
                        this.log(`Baixando: ${id}`, 'info');
                        
                        const res = await fetch(this.getApiUrl(`/coins/${id}/market_chart?vs_currency=${vs}&days=${fetchDays}&interval=daily`));
                        if(res.status === 429) throw new Error('Rate Limit');
                        const json = await res.json();
                        
                        if(json.prices) {
                            this.historyCache[key] = { ts: Date.now(), data: json.prices };
                            localStorage.setItem('crypto_history_cache', JSON.stringify(this.historyCache));
                            if(id === 'bitcoin') this.calculateMayer(json.prices);
                        }
                        this.updateLineChart(targets);
                    });
                });
            }

            calculatePortfolio() {
                const portfolio = {}; let totalBal=0, totalInv=0;
                const sym = this.displayCurrency === 'BRL' ? 'R$' : '$';
                const isBRL = this.displayCurrency === 'BRL';

                this.transactions.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.transactions.forEach(tx => {
                    if(!portfolio[tx.coinId]) portfolio[tx.coinId] = { qty:0, invest:0, beInvest: 0 }; // Added beInvest
                    
                    let cost = tx.totalCost;
                    const txIsBRL = (!tx.currency || tx.currency === 'BRL');
                    
                    if(txIsBRL !== isBRL && this.rateBrlToUsd > 0) {
                        cost = txIsBRL ? cost * this.rateBrlToUsd : cost / this.rateBrlToUsd;
                    }
                    
                    // L√≥gica para agrega√ß√£o do Break Even
                    // Se existe BE salvo, usamos. Se n√£o, usamos o pre√ßo m√©dio de compra como fallback.
                    // Importante converter o BE salvo (que est√° na moeda original da transa√ß√£o) para a moeda atual de exibi√ß√£o
                    let txBePrice = tx.breakEven || (tx.amount > 0 ? tx.totalCost/tx.amount : 0);
                    
                    if (tx.breakEven && txIsBRL !== isBRL && this.rateBrlToUsd > 0) {
                         txBePrice = txIsBRL ? txBePrice * this.rateBrlToUsd : txBePrice / this.rateBrlToUsd;
                    }
                    
                    if(tx.type === 'buy') { 
                        portfolio[tx.coinId].qty += tx.amount; 
                        portfolio[tx.coinId].invest += cost; 
                        // O "investimento" para fins de BE √© (Pre√ßo de Sa√≠da Necess√°rio * Quantidade)
                        portfolio[tx.coinId].beInvest += (txBePrice * tx.amount);
                    }
                    else { 
                        const avg = portfolio[tx.coinId].qty > 0 ? portfolio[tx.coinId].invest/portfolio[tx.coinId].qty : 0; 
                        const avgBe = portfolio[tx.coinId].qty > 0 ? portfolio[tx.coinId].beInvest/portfolio[tx.coinId].qty : 0;
                        
                        portfolio[tx.coinId].invest -= avg * tx.amount; 
                        // Removemos proporcionalmente do bolo do BE tamb√©m
                        portfolio[tx.coinId].beInvest -= avgBe * tx.amount;
                        portfolio[tx.coinId].qty -= tx.amount; 
                    }
                });

                const container = document.getElementById('assetsContainer');
                if(container) {
                    container.innerHTML = '';
                    const labels=[], data=[], colors=[];
                    
                    Object.keys(portfolio).forEach(id => {
                        const item = portfolio[id];
                        if(item.qty <= 0.000001) return;
                        const config = this.coinMap[id];
                        if(!config) return;

                        const curKey = isBRL ? 'brl' : 'usd';
                        const price = this.prices[id] ? this.prices[id][curKey] : 0;
                        const balance = item.qty * price;
                        const profit = balance - item.invest;
                        const pct = item.invest > 0 ? (profit/item.invest)*100 : 0;

                        totalBal += balance; totalInv += item.invest;
                        labels.push(config.name); data.push(balance); colors.push(config.color);

                        const icon = this.getIconHtml(config);
                        const sBal = this.formatMoney(balance, sym);
                        const sPrice = this.formatMoney(price, sym);
                        const sPM = this.formatMoney(item.invest/item.qty, sym);
                        // Calcula o BE M√©dio Ponderado
                        const avgBeVal = item.qty > 0 ? item.beInvest / item.qty : 0;
                        const sBE = this.formatMoney(avgBeVal, sym);
                        
                        const sQty = this.formatQuantity(item.qty, config.symbol);

                        container.innerHTML += `
                        <div class="glass-panel rounded-xl p-4 border border-gray-700 relative overflow-hidden transition">
                            <div class="flex justify-between items-center mb-2 relative z-10">
                                <div class="flex items-center">
                                    <div class="mr-3">${icon}</div>
                                    <div><div class="font-bold text-white text-sm">${config.name}</div><div class="text-xs text-gray-400 font-mono">${sQty}</div></div>
                                </div>
                                <div class="text-right"><div class="font-bold text-white text-sm">${sBal}</div><div class="text-[10px] text-gray-500">${sPrice}</div></div>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-700/50 text-xs relative z-10">
                                <div class="flex gap-3">
                                    <span class="text-gray-400" title="Pre√ßo M√©dio de Compra">PM: ${sPM}</span>
                                    <span class="text-purple-400 font-bold" title="Pre√ßo M√©dio de Sa√≠da (Break-even)">BE: ${sBE}</span>
                                </div>
                                <span class="${profit>=0?'text-green-400':'text-red-400'} font-bold">${profit>=0?'+':''}${pct.toFixed(2)}%</span>
                            </div>
                            <div class="absolute -right-4 -top-4 w-24 h-24 rounded-full opacity-5 filter blur-2xl" style="background-color:${config.color}"></div>
                        </div>`;
                    });
                    this.updateDonut(labels, data, colors);
                }

                const totProfit = totalBal - totalInv;
                const totPct = totalInv > 0 ? (totProfit/totalInv)*100 : 0;
                
                const elBal = document.getElementById('totalBalance');
                if(elBal) elBal.innerText = this.formatMoney(totalBal, sym);
                const elInv = document.getElementById('totalInvested');
                if(elInv) elInv.innerText = this.formatMoney(totalInv, sym);
                const elPnL = document.getElementById('totalPnL');
                if(elPnL) {
                    const sP = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${sym} ${totProfit.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
                    elPnL.innerHTML = `<span class="${totProfit>=0?'text-green-400':'text-red-400'}">${sP} (${totPct.toFixed(2)}%)</span>`;
                }
                
                this.updateTitle(); 
                this.renderHistory();
            }

            renderHistory() {
                const tbody = document.getElementById('historyTableBody');
                if(!tbody) return;
                tbody.innerHTML = '';
                const sym = this.displayCurrency === 'BRL' ? 'R$' : '$';
                
                [...this.transactions].reverse().forEach(tx => {
                    const config = this.coinMap[tx.coinId] || DEFAULT_COINS.bitcoin;
                    const isBuy = tx.type === 'buy';
                    const originalSym = (!tx.currency || tx.currency === 'BRL') ? 'R$' : '$';
                    const icon = this.getIconHtml(config).replace('w-full h-full', 'w-4 h-4').replace('32px', '16px'); 
                    const smallIcon = `<div class="w-4 h-4 mr-2 rounded-full overflow-hidden flex items-center justify-center">${icon}</div>`;
                    
                    const sCost = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${originalSym} ${tx.totalCost.toLocaleString()}`;
                    const sQty = this.formatQuantity(tx.amount, config.symbol);
                    
                    // MOSTRAR BREAK-EVEN NA TABELA
                    let beValue = '-';
                    if (tx.breakEven && tx.breakEven > 0) {
                         beValue = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${originalSym} ${tx.breakEven.toLocaleString('pt-BR', {maximumFractionDigits: 2})}`;
                    }

                    tbody.innerHTML += `
                    <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition">
                        <td class="p-3 text-gray-400">${new Date(tx.date).toLocaleDateString()}</td>
                        <td class="p-3 text-white font-bold text-xs flex items-center">${smallIcon} ${config.symbol}</td>
                        <td class="p-3"><span class="text-xs font-bold ${isBuy?'text-green-400':'text-red-400'}">${isBuy?'C':'V'}</span></td>
                        <td class="p-3 text-right text-gray-300 text-xs font-mono">${sQty}</td>
                        <td class="p-3 text-right text-gray-300 text-xs">${sCost}</td>
                        <td class="p-3 text-right text-purple-300 text-xs font-bold">${beValue}</td>
                        <td class="p-3 text-right">
                            <button onclick="app.openEditModal(${tx.id})" class="text-gray-500 hover:text-yellow-400 p-1" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                            <button onclick="app.deleteTransaction(${tx.id})" class="text-gray-500 hover:text-red-500 p-1" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }

            updateLineChart(ids) {
                const canvas = document.getElementById('historyChart');
                if(!canvas) return;
                
                const refId = ids.find(id => this.historyCache[`${id}_usd_365`]);
                if(!refId) return;

                const ctx = canvas.getContext('2d');
                // Fatiar dados do cache 365 dias conforme a sele√ß√£o atual (30, 90...)
                const fullData = this.historyCache[`${refId}_usd_365`].data;
                const slice = this.chartDays; 
                const slicedRef = fullData.slice(-slice);
                const timestamps = slicedRef.map(p => p[0]);
                
                const isBRL = this.displayCurrency === 'BRL';

                // 1. Patrim√¥nio
                const totalValues = timestamps.map((ts, idx) => {
                    const port = this.getPortfolioAtDate(ts);
                    let tot = 0;
                    ids.forEach(id => {
                        const key = `${id}_usd_365`;
                        if(this.historyCache[key] && port[id]) {
                            const coinData = this.historyCache[key].data.slice(-slice);
                            if(coinData[idx]) {
                                const pUsd = coinData[idx][1];
                                const price = (isBRL && this.rateBrlToUsd > 0) ? pUsd / this.rateBrlToUsd : pUsd;
                                tot += price * port[id];
                            }
                        }
                    });
                    return tot;
                });

                // 2. Pre√ßo BTC
                const btcKey = `bitcoin_usd_365`;
                const btcValues = this.historyCache[btcKey] ? this.historyCache[btcKey].data.slice(-slice).map(p => {
                    return (isBRL && this.rateBrlToUsd > 0) ? p[1] / this.rateBrlToUsd : p[1];
                }) : [];

                // 3. Pre√ßo M√©dio Pessoal (Linha Constante - Piso)
                const avgValues = timestamps.map(ts => {
                    const pointDate = new Date(ts);
                    pointDate.setHours(23, 59, 59); 

                    let invested = 0;
                    let qty = 0;
                    
                    const txsUntilDate = this.transactions
                        .filter(t => t.coinId === 'bitcoin')
                        .filter(t => {
                            const parts = t.date.split('-');
                            const txDate = new Date(parts[0], parts[1]-1, parts[2]);
                            return txDate <= pointDate;
                        })
                        .sort((a,b) => new Date(a.date) - new Date(b.date));

                    txsUntilDate.forEach(t => {
                        let cost = t.totalCost;
                        const tBRL = (!t.currency || t.currency === 'BRL');
                        if(tBRL !== isBRL && this.rateBrlToUsd > 0) {
                            cost = tBRL ? cost * this.rateBrlToUsd : cost / this.rateBrlToUsd;
                        }

                        if(t.type === 'buy') { 
                            invested += cost; 
                            qty += t.amount; 
                        } else { 
                            const currentAvg = qty > 0 ? invested / qty : 0;
                            invested -= currentAvg * t.amount; 
                            qty -= t.amount; 
                        }
                    });

                    return qty > 0.00000001 ? (invested / qty) : null;
                });

                if(this.lineChart) this.lineChart.destroy();
                const gradient = ctx.createLinearGradient(0,0,0,400);
                gradient.addColorStop(0, 'rgba(59,130,246,0.5)'); gradient.addColorStop(1, 'rgba(59,130,246,0.0)');

                this.lineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps.map(t => new Date(t).toLocaleDateString()),
                        datasets: [
                            { label: 'Patrim√¥nio', data: totalValues, borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, fill: true, pointRadius: 0, pointHoverRadius: 6, yAxisID: 'y' },
                            { label: 'Pre√ßo BTC', data: btcValues, borderColor: '#f59e0b', borderDash: [3,3], borderWidth: 1.5, pointRadius: 0, fill: false, yAxisID: 'y1' },
                            { label: 'Meu M√©dio', data: avgValues, borderColor: '#d946ef', borderDash: [5,5], borderWidth: 2, pointRadius: 0, fill: false, spanGaps: true, yAxisID: 'y1' }
                        ]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, 
                        plugins: { legend: {display:true, labels:{color:'#9ca3af', font:{size:10}}}, tooltip: {mode:'index', intersect:false} },
                        scales: { x: {display:false}, y: {type:'linear', display:true, position:'left', grid:{color:'#374151'}, ticks: {color:'#60a5fa', callback: v=>(v/1000).toFixed(0)+'k'}}, y1: {type:'linear', display:true, position:'right', grid:{drawOnChartArea:false}, ticks: {color:'#f59e0b', callback: v=>(v/1000).toFixed(0)+'k'}} }
                    }
                });
            }

            // --- UTILS ---
            getPortfolioAtDate(ts) {
                const limit = new Date(ts); const coins = {};
                this.transactions.forEach(tx => {
                    const [y,m,d] = tx.date.split('-').map(Number); const txDate = new Date(y, m-1, d, 12, 0, 0);
                    if(txDate <= limit) { if(!coins[tx.coinId]) coins[tx.coinId] = 0; if(tx.type === 'buy') coins[tx.coinId] += tx.amount; else coins[tx.coinId] -= tx.amount; }
                }); return coins;
            }
            
            updateDonut(l, d, c) {
                const cv = document.getElementById('portfolioChart');
                const m = document.getElementById('emptyChartMsg');
                if(!cv || typeof Chart === 'undefined') return;
                if(this.donutChart) this.donutChart.destroy();
                if(m) m.classList.toggle('hidden', d.length > 0);
                this.donutChart = new Chart(cv.getContext('2d'), { type: 'doughnut', data: { labels: l, datasets: [{data: d, backgroundColor: c, borderWidth: 0}] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: {legend:{display:false}} } });
            }

            calculateMayer(prices) {
                if(!prices || prices.length < 200) return;
                const last200 = prices.slice(-200);
                const sum = last200.reduce((acc, p) => acc + p[1], 0);
                const ma200 = sum / 200;
                const current = last200[last200.length-1][1];
                const mayer = current / ma200;

                const elVal = document.getElementById('mayerValue');
                const elStat = document.getElementById('mayerStatus');
                const elInd = document.getElementById('mayerIndicator');
                
                if(elVal) elVal.innerText = mayer.toFixed(2);
                if(elInd) elInd.style.left = `${Math.min((mayer/3)*100, 100)}%`;
                
                if(elStat) {
                    if(mayer < 0.55) { elStat.innerText = "Desconto"; elStat.className = "text-xs font-bold text-green-400"; }
                    else if(mayer < 1.1) { elStat.innerText = "Acumula√ß√£o"; elStat.className = "text-xs font-bold text-green-300"; }
                    else if(mayer < 2.4) { elStat.innerText = "Bull Market"; elStat.className = "text-xs font-bold text-yellow-400"; }
                    else { elStat.innerText = "Bolha"; elStat.className = "text-xs font-bold text-red-500"; }
                }
            }

            // --- Handlers ---
            togglePrivacy() {
                this.privacyMode = !this.privacyMode;
                localStorage.setItem('crypto_privacy', this.privacyMode);
                
                // Atualiza √≠cone
                const icon = document.getElementById('privacyIconMobile');
                if(icon) icon.className = this.privacyMode ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
                
                // Recalcula tudo para aplicar o blur
                this.calculatePortfolio();
                this.updateTitle();
                
                this.log(this.privacyMode ? 'Privacidade ativada' : 'Privacidade desativada', 'info');
            }
            
            setCurrency(c) { 
                this.displayCurrency = c; 
                localStorage.setItem('crypto_currency', c); 
                this.updateCurrencyUI(); 
                this.calculatePortfolio(); 
                this.fetchHistory(); 
                this.calculateBreakEven(); // <--- ADD THIS
            }
            updateCurrencyUI() { 
                const b1 = document.getElementById('btn-currency-brl'); const b2 = document.getElementById('btn-currency-usd'); 
                const l = document.getElementById('costCurrencyLabel');
                if(!b1) return;
                if(this.displayCurrency === 'BRL') { 
                    b1.classList.replace('text-gray-400','text-white'); b1.classList.add('bg-blue-600'); b2.classList.remove('bg-blue-600','text-white'); b2.classList.add('text-gray-400'); 
                    if(l) l.innerText = 'R$';
                }
                else { 
                    b2.classList.replace('text-gray-400','text-white'); b2.classList.add('bg-blue-600'); b1.classList.remove('bg-blue-600','text-white'); b1.classList.add('text-gray-400'); 
                    if(l) l.innerText = 'USD';
                }
            }

            // NOVO: Handler para alterar Unidade (BTC/SATS)
            setUnit(u) {
                this.displayUnit = u;
                localStorage.setItem('crypto_unit', u);
                this.updateUnitUI();
                this.calculatePortfolio();
                this.renderHistory();
            }

            // NOVO: Atualiza visual do bot√£o de Unidade
            updateUnitUI() {
                const b1 = document.getElementById('btn-unit-btc');
                const b2 = document.getElementById('btn-unit-sats');
                if(!b1) return;
                
                // Atualiza bot√µes da Navbar
                if(this.displayUnit === 'BTC') {
                    b1.classList.replace('text-gray-400','text-white'); 
                    b1.classList.add('bg-orange-500'); 
                    b2.classList.remove('bg-orange-500','text-white'); 
                    b2.classList.add('text-gray-400');
                } else {
                    b2.classList.replace('text-gray-400','text-white'); 
                    b2.classList.add('bg-orange-500'); 
                    b1.classList.remove('bg-orange-500','text-white'); 
                    b1.classList.add('text-gray-400');
                }

                // Atualiza r√≥tulo e placeholder no formul√°rio
                const lbl = document.getElementById('qtyUnitLabel');
                if (lbl) lbl.innerText = this.displayUnit === 'BTC' ? '(BTC)' : '(SATS)';
                
                const inp = document.getElementById('amountInput');
                if(inp) {
                    inp.placeholder = this.displayUnit === 'BTC' ? '0.00000000' : '0';
                    inp.step = this.displayUnit === 'BTC' ? '0.00000001' : '1';
                }
            }

            changeRange(d) { 
                this.chartDays = d; 
                localStorage.setItem('crypto_chart_days', d); // PERSIST√äNCIA
                this.updateRangeUI(); 
                this.fetchHistory(); 
            }
            
            handleAddTransaction(e) { 
                e.preventDefault(); 
                
                let qty = parseFloat(document.getElementById('amountInput').value);
                const unitPrice = parseFloat(document.getElementById('costInput').value);
                
                // SE ESTIVER EM SATS, CONVERTE PARA BTC ANTES DE SALVAR
                if (this.displayUnit === 'SATS') {
                    qty = qty / 100000000;
                }
                
                // Salva o Custo Total no banco (sempre baseado em BTC)
                const totalCost = qty * unitPrice;

                // Calcula Break-even para salvar
                const taxBuy = parseFloat(document.getElementById('taxBuyInput').value) || 0;
                const taxSell = parseFloat(document.getElementById('taxSellInput').value) || 0;

                const taxBuyVal = (totalCost * taxBuy) / 100;
                const totalW = totalCost + taxBuyVal;
                const be = taxSell > 0 ? totalW / (qty * (1 - taxSell/100)) : totalW / qty;

                const tx = { 
                    id: Date.now(), 
                    coinId: document.getElementById('coinSelect').value, 
                    type: document.getElementById('typeSelect').value, 
                    amount: qty, 
                    totalCost: totalCost,
                    taxBuy: taxBuy,
                    taxSell: taxSell,
                    breakEven: be, // Salva o Break-Even calculado
                    currency: this.displayCurrency, 
                    date: document.getElementById('dateInput').value 
                };

                this.transactions.push(tx); localStorage.setItem('crypto_txs', JSON.stringify(this.transactions)); this.calculatePortfolio(); 
                
                e.target.reset(); 
                document.getElementById('dateInput').valueAsDate = new Date(); 
                document.getElementById('smartPriceInfo').classList.add('hidden');
                document.getElementById('calculationSummary').classList.add('hidden');
                
                // Restaura placeholder correto ap√≥s limpar
                this.updateUnitUI();
                
                this.log('Transa√ß√£o adicionada.', 'success');
                this.fetchHistory();
            }
            
            deleteTransaction(id) { 
                if(confirm('Apagar?')) { 
                    this.transactions = this.transactions.filter(t => t.id !== id); 
                    localStorage.setItem('crypto_txs', JSON.stringify(this.transactions)); 
                    this.calculatePortfolio(); 
                    // IMPORTANTE: Atualiza o gr√°fico
                    this.fetchHistory();
                } 
            }
            
            clearAllData() { 
                if(confirm('Resetar tudo?')) { 
                    this.transactions = []; 
                    localStorage.setItem('crypto_txs', JSON.stringify(this.transactions)); 
                    this.calculatePortfolio(); 
                    // IMPORTANTE: Atualiza o gr√°fico
                    this.fetchHistory();
                } 
            }
            
            forceClearCache() { localStorage.removeItem('crypto_prices_cache'); localStorage.removeItem('crypto_history_cache'); this.prices={}; this.refreshAll(true); }
            
            saveSettings(e) { e.preventDefault(); this.apiConfig = { type: document.querySelector('input[name="apiType"]:checked').value, key: document.getElementById('apiKeyInput').value.trim() }; localStorage.setItem('crypto_api_config', JSON.stringify(this.apiConfig)); this.closeSettings(); }
            async smartSave() { const c = JSON.stringify({ transactions: this.transactions, customCoins: safeParse('crypto_custom_coins', {}), version: '1.4' }, null, 2); try { const h = await window.showSaveFilePicker({ suggestedName: 'backup.json', types: [{ description: 'JSON', accept: {'application/json': ['.json']} }] }); const w = await h.createWritable(); await w.write(c); await w.close(); } catch(e) { console.log(e); } }
            importData(input) { 
                const f = input.files[0]; 
                if(!f) return; 
                const r = new FileReader(); 
                r.onload = (e) => { 
                    try { 
                        const d = JSON.parse(e.target.result); 
                        if(confirm(`Restaurar backup com ${d.transactions ? d.transactions.length : 0} transa√ß√µes?`)) { 
                            // Atualiza transa√ß√µes
                            if (d.transactions) {
                                this.transactions = d.transactions;
                                localStorage.setItem('crypto_txs', JSON.stringify(this.transactions));
                            }
                            // Atualiza moedas customizadas
                            if(d.customCoins) {
                                localStorage.setItem('crypto_custom_coins', JSON.stringify(d.customCoins));
                            }
                            alert('Dados restaurados com sucesso! O app ser√° recarregado.');
                            location.reload(); 
                        } 
                    } catch(er) { 
                        console.error(er);
                        alert('Erro ao ler o arquivo JSON. Verifique o formato.'); 
                    } 
                }; 
                r.readAsText(f); 
                input.value = ''; // Reset input
            }
            
            generateExportCode() { const p = { transactions: this.transactions, customCoins: safeParse('crypto_custom_coins', {}), ts: Date.now() }; document.getElementById('exportCodeInput').value = btoa(JSON.stringify(p)); }
            
            // Fun√ß√£o Inteligente de Importa√ß√£o (Aceita Base64 ou JSON Puro)
            importFromCode() { 
                const raw = document.getElementById('importCodeInput').value.trim();
                if (!raw) return alert('Cole algo!');

                try { 
                    let jsonStr = raw;
                    // Tenta decodificar se n√£o come√ßar com {
                    if (!raw.startsWith('{')) {
                        try { jsonStr = atob(raw); } catch(e) { console.warn("N√£o √© base64, tentando JSON direto"); }
                    }
                    
                    const d = JSON.parse(jsonStr); 
                    if(confirm('Restaurar?')) { 
                        this.transactions = d.transactions || []; 
                        localStorage.setItem('crypto_txs', JSON.stringify(this.transactions)); 
                        if(d.customCoins) localStorage.setItem('crypto_custom_coins', JSON.stringify(d.customCoins)); 
                        location.reload(); 
                    } 
                } catch(e) { 
                    alert('C√≥digo inv√°lido ou corrompido.'); 
                } 
            }
            
            async searchCoins() { 
                const q = document.getElementById('coinSearchInput').value; const d = document.getElementById('searchResults'); 
                if(q.length<2 || !d) return; d.innerHTML='...'; 
                try { const r = await fetch(this.getApiUrl(`/search?query=${q}`)); const j = await r.json(); d.innerHTML=''; 
                    j.coins.slice(0,10).forEach(c => { 
                        const e = document.createElement('div'); e.className = 'flex justify-between p-2 bg-gray-900/50 rounded mb-2 cursor-pointer hover:bg-gray-800 items-center'; 
                        e.innerHTML = `<span class="text-white font-bold">${c.name}</span><i class="fa-solid fa-plus text-blue-400"></i>`; 
                        e.onclick = () => { 
                            this.coinMap[c.id] = { symbol: c.symbol.toUpperCase(), name: c.name, color: '#9ca3af', image: c.thumb }; 
                            const cu = safeParse('crypto_custom_coins', {}); cu[c.id] = this.coinMap[c.id]; localStorage.setItem('crypto_custom_coins', JSON.stringify(cu)); 
                            this.populateCoinSelect(document.getElementById('coinSelect'));
                            this.populateCoinSelect(document.getElementById('editCoinSelect'));
                            document.getElementById('coinSelect').value = c.id; this.updateFormTheme(); 
                            document.getElementById('searchModal').classList.add('hidden'); this.refreshAll(true); 
                        }; d.appendChild(e); 
                    }); 
                } catch(e) { d.innerHTML='Erro'; } 
            }
            
            copyDonationAddress() { navigator.clipboard.writeText("Bc1qn9gjwevesf8xhqamvt8lcnwmyz4e5lfdqzc7h0"); alert("Bitcoin Address Copied!"); }
            copyLightningAddress() { navigator.clipboard.writeText("arthurmiguel@bipa.app"); alert("Lightning Address Copied!"); }

            exportToCsv() {
                if (this.transactions.length === 0) {
                    alert("Nenhuma transa√ß√£o para exportar.");
                    return;
                }

                const headers = [
                    "ID", "Data", "Ativo", "Symbol", "Tipo", "Quantidade", 
                    "Valor Total", "Moeda", "Break-even", "Taxa Compra (%)", "Taxa Venda (%)"
                ];

                const csvRows = [headers.join(',')];

                for (const tx of this.transactions) {
                    const config = this.coinMap[tx.coinId] || {};
                    const row = [
                        tx.id,
                        tx.date,
                        config.name || tx.coinId,
                        config.symbol || '',
                        tx.type,
                        tx.amount,
                        tx.totalCost,
                        tx.currency,
                        tx.breakEven || 0,
                        tx.taxBuy || 0,
                        tx.taxSell || 0
                    ].join(',');
                    csvRows.push(row);
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "crypto_control_transacoes.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            runSimulation() {
                const t = parseFloat(document.getElementById('simPriceInput').value); if (!t) return alert('Valor inv√°lido');
                const btc = this.prices.bitcoin ? this.prices.bitcoin.usd : 0; if (btc === 0) return alert('Aguarde dados...');
                const g = t / btc; let proj = 0;
                Object.keys(this.coinMap).forEach(id => {
                    const qty = this.transactions.filter(tx => tx.coinId === id).reduce((acc, tx) => tx.type === 'buy' ? acc + tx.amount : acc - tx.amount, 0);
                    if (qty > 0) { const p = this.prices[id] ? this.prices[id].usd : 0; const val = qty * p; proj += (id === 'bitcoin' ? qty * t : val * g); }
                });
                if (this.displayCurrency === 'BRL' && this.rateBrlToUsd > 0) proj = proj / this.rateBrlToUsd;
                const sym = this.displayCurrency === 'BRL' ? 'R$' : '$';
                document.getElementById('simResult').classList.remove('hidden');
                const displayProj = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${sym} ${proj.toLocaleString('pt-BR', {maximumFractionDigits:2})}`;
                document.getElementById('simTotalValue').innerText = displayProj;
                const displayGrowth = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${(g*100-100).toFixed(1)}%`;
                document.getElementById('simProfit').innerText = `Crescimento: ${displayGrowth}`;
            }

            // --- Gerenciamento do Modal de Edi√ß√£o ---
            openEditModal(txId) {
                const tx = this.transactions.find(t => t.id === txId);
                if (!tx) return;

                // Preenche os campos do modal
                document.getElementById('editTxId').value = tx.id;
                document.getElementById('editCoinSelect').value = tx.coinId;
                document.getElementById('editTypeSelect').value = tx.type;
                document.getElementById('editAmountInput').value = tx.amount;
                // O custo unit√°rio √© o custo total dividido pela quantidade
                document.getElementById('editCostInput').value = (tx.totalCost / tx.amount).toFixed(2);
                document.getElementById('editDateInput').value = tx.date;
                document.getElementById('editTaxBuyInput').value = tx.taxBuy || 0;
                document.getElementById('editTaxSellInput').value = tx.taxSell || 0;

                // Exibe o modal
                document.getElementById('editTxModal').classList.remove('hidden');
            }

            closeEditModal() {
                document.getElementById('editTxModal').classList.add('hidden');
            }

            handleUpdateTransaction(e) {
                e.preventDefault();

                const txId = parseInt(document.getElementById('editTxId').value);
                const txIndex = this.transactions.findIndex(t => t.id === txId);
                if (txIndex === -1) {
                    alert("Erro: Transa√ß√£o n√£o encontrada!");
                    return;
                }

                const qty = parseFloat(document.getElementById('editAmountInput').value);
                const unitPrice = parseFloat(document.getElementById('editCostInput').value);
                const totalCost = qty * unitPrice;
                const taxBuy = parseFloat(document.getElementById('editTaxBuyInput').value) || 0;
                const taxSell = parseFloat(document.getElementById('editTaxSellInput').value) || 0;

                const taxBuyVal = (totalCost * taxBuy) / 100;
                const totalW = totalCost + taxBuyVal;
                const be = taxSell > 0 ? totalW / (qty * (1 - taxSell/100)) : totalW / qty;

                // Atualiza a transa√ß√£o
                const updatedTx = {
                    ...this.transactions[txIndex], // Mant√©m propriedades originais
                    coinId: document.getElementById('editCoinSelect').value,
                    type: document.getElementById('editTypeSelect').value,
                    amount: qty,
                    totalCost: totalCost,
                    date: document.getElementById('editDateInput').value,
                    taxBuy: taxBuy,
                    taxSell: taxSell,
                    breakEven: be
                };
                
                this.transactions[txIndex] = updatedTx;

                localStorage.setItem('crypto_txs', JSON.stringify(this.transactions));
                this.calculatePortfolio();
                this.fetchHistory();
                this.closeEditModal();
                this.log('Transa√ß√£o atualizada.', 'success');
            }
            

            // ===== SMART ADD: Buscar pre√ßo hist√≥rico (Unit√°rio) =====
            async smartFetchPrice() {
                const dateInput = document.getElementById('dateInput');
                const coinSelect = document.getElementById('coinSelect');
                const infoBox = document.getElementById('smartPriceInfo');
                const infoText = document.getElementById('smartPriceText');
                const priceInput = document.getElementById('costInput'); // Agora √© Pre√ßo Unit√°rio

                if (!dateInput.value || !coinSelect.value) {
                    infoBox.classList.add('hidden');
                    return;
                }

                const selectedDate = new Date(dateInput.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);

                // Se data for hoje ou futuro, esconde box e sai
                if (selectedDate >= today) {
                    infoBox.classList.add('hidden');
                    return;
                }

                infoBox.classList.remove('hidden');
                infoText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Buscando pre√ßo hist√≥rico...';

                // === VERIFICA√á√ÉO DE ARQUIVO LOCAL PRIMEIRO ===
                const coinId = coinSelect.value;
                // O arquivo local s√≥ serve se for Bitcoin
                if (coinId === 'bitcoin' && this.localData && this.localData[dateInput.value]) {
                    const localPrice = this.localData[dateInput.value];
                    
                    // SE ENCONTRAR NO ARQUIVO (QUE √â EM D√ìLAR), MUDA PARA USD AUTOMATICAMENTE
                    this.setCurrency('USD');
                    const isBRL = false; // For√ßa modo USD
                    
                    // Se estiver em BRL, precisamos converter o pre√ßo do CSV (que √© em USD)
                    const priceDisplay = isBRL && this.rateBrlToUsd > 0 
                        ? localPrice / this.rateBrlToUsd 
                        : localPrice;
                        
                    const symbol = isBRL ? 'R$' : '$';

                    priceInput.value = priceDisplay.toFixed(2);
                    
                    // DD-MM-YYYY para exibir bonito
                    const dateStr = dateInput.value.split('-').reverse().join('-');
                    
                    infoText.innerHTML = `<i class="fa-solid fa-file-csv text-orange-400"></i> Arquivo Local (${dateStr}): <strong>${symbol} ${priceDisplay.toLocaleString('pt-BR')}</strong>`;
                    
                    this.calculateBreakEven();
                    return; // Encerra aqui, economizando a chamada de API
                }

                // === SE N√ÉO ACHOU LOCAL, CHAMA A API ===
                try {
                    // A API da Coingecko exige DD-MM-YYYY. Se o input der YYYY-MM-DD, invertemos.
                    const dateStr = dateInput.value.split('-').reverse().join('-');
                    
                    const url = `https://api.coingecko.com/api/v3/coins/${coinId}/history?date=${dateStr}&localization=false`;
                    const res = await fetch(url);
                    
                    if (!res.ok) throw new Error('API Error');
                    
                    const json = await res.json();
                    const priceUsd = json.market_data?.current_price?.usd;

                    if (!priceUsd) throw new Error('Pre√ßo n√£o encontrado');

                    const isBRL = this.displayCurrency === 'BRL';
                    const priceDisplay = isBRL ? (priceUsd / this.rateBrlToUsd) : priceUsd;
                    const symbol = isBRL ? 'R$' : '$';

                    infoBox.classList.remove('hidden');
                    const coinName = this.coinMap[coinId]?.name || coinId;
                    infoText.innerHTML = `<i class="fa-solid fa-check text-green-400"></i> Online ${dateStr}: <strong>${symbol} ${priceDisplay.toLocaleString('pt-BR')}</strong>`;

                    // Preenche automaticamente o pre√ßo unit√°rio
                    priceInput.value = priceDisplay.toFixed(2);
                    
                    // Chama o calculo de totais
                    this.calculateBreakEven();

                } catch(e) {
                    infoBox.classList.remove('hidden');
                    infoText.innerHTML = `<i class="fa-solid fa-exclamation-circle text-red-400"></i> Erro: ${e.message}`;
                }
            }

            // ===== BREAK-EVEN PRICE: Calcula Total Gasto e Ponto de Empate =====
            calculateBreakEven() {
                let amount = parseFloat(document.getElementById('amountInput').value) || 0;
                const unitPrice = parseFloat(document.getElementById('costInput').value) || 0; // Agora √© Unit√°rio
                const taxBuy = parseFloat(document.getElementById('taxBuyInput').value) || 0;
                const taxSell = parseFloat(document.getElementById('taxSellInput').value) || 0;

                // AJUSTE DE SATS: Se o usu√°rio digitou em Sats, divide por 100m para c√°lculos internos em BTC
                if (this.displayUnit === 'SATS') {
                    amount = amount / 100000000;
                }

                // PEGA O ELEMENTO DE RESUMO
                const summaryBox = document.getElementById('calculationSummary');
                const totalValueEl = document.getElementById('calcTotalValue');
                const breakEvenValueEl = document.getElementById('calcBreakEvenValue');
                const symbol = this.displayCurrency === 'BRL' ? 'R$' : '$';

                if (amount <= 0 || unitPrice <= 0) {
                    // Null Check: Ensure summaryBox exists before accessing classList
                    if(summaryBox) summaryBox.classList.add('hidden');
                    return;
                }

                // 1. Calcula o Total Gasto (Valor Real Pago)
                const totalSpent = amount * unitPrice;
                
                // MOSTRA O RESUMO
                if(summaryBox) summaryBox.classList.remove('hidden');
                if(totalValueEl) totalValueEl.innerText = this.privacyMode ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `${symbol} ${totalSpent.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                // 2. Calcula Break-Even
                const taxBuyValue = (totalSpent * taxBuy) / 100;
                const totalWithTaxBuy = totalSpent + taxBuyValue;
                
                const breakEven = taxSell > 0 
                    ? totalWithTaxBuy / (amount * (1 - taxSell / 100))
                    : totalWithTaxBuy / amount;
                
                if(breakEvenValueEl) {
                    if (this.privacyMode) {
                        breakEvenValueEl.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    } else {
                        breakEvenValueEl.innerText = `${symbol} ${breakEven.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    }
                }
            }
        }

        const app = new CryptoApp();
    </script>
</body>
</html>